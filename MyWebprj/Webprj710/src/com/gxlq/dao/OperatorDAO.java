package com.gxlq.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import com.gxlq.entity.Operator;
import com.gxlq.entity.Role;

/**
 * ????????CURD????
 *
 * @author johny
 * ??��???
 */
public class OperatorDAO extends BaseDAO {
    /**
     * ???????
     *
     * @param operator ?????????????????????��{id=1,name=???}
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public void add(Operator operator) throws ClassNotFoundException, SQLException {
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????��???????��??1???????????????????????
        PreparedStatement pstmt =
                conn.prepareStatement("insert into operator(username,password,tel,pic,reserve,role) values(?,?,?,?,?,?)");
        //?????��?????,???????????????
        pstmt.setString(1, operator.getUsername());
        pstmt.setString(2, operator.getPassword());
        pstmt.setString(3, operator.getTel());
        pstmt.setString(4, operator.getPic());
        pstmt.setString(5, operator.getReserve());
        pstmt.setInt(6, operator.getRole().getId());
        //???SQL???,??????????mysql????
        pstmt.executeUpdate();
        //????????????
        super.closeConnection(conn);
    }

    /**
     * ???????
     *
     * @param operator ????????????????????��{id=3,name=????}
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public void merge(Operator operator) throws ClassNotFoundException, SQLException {
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????��???????��??1???????????????????????
        PreparedStatement pstmt =
                conn.prepareStatement("update operator set password=?,tel=?,pic=?,reserve=?,role=? where id=?");
        //?????��?????,???????????????
        pstmt.setString(1, operator.getPassword());
        pstmt.setString(2, operator.getTel());
        pstmt.setString(3, operator.getPic());
        pstmt.setString(4, operator.getReserve());
        pstmt.setInt(5, operator.getRole().getId());
        pstmt.setInt(6, operator.getId());
        //???SQL???,??????????mysql????
        pstmt.executeUpdate();
        //????????????
        super.closeConnection(conn);
    }

    /**
     * ????????
     *
     * @param operator ????????????????????��{id=3,name=????}
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public void delete(Operator operator) throws ClassNotFoundException, SQLException {
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????��???????��??1???????????????????????
        PreparedStatement pstmt =
                conn.prepareStatement("delete from operator where id=?");
        //?????��?????,???????????????
        pstmt.setInt(1, operator.getId());
        //???SQL???,??????????mysql????
        pstmt.executeUpdate();
        //????????????
        super.closeConnection(conn);
    }

    //????????

    /**
     * ????????????????
     *
     * @return ???????��????��?????????operator???????????????
     * @throws ClassNotFoundException
     * @throws SQLException
     */
    public Operator[] findAll() throws ClassNotFoundException, SQLException {
        //????????
        Operator[] operators = new Operator[findTotal()]; //???????????null
        int i = 0;
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????��???????��??1???????????????????????
        PreparedStatement pstmt = conn.prepareStatement("select * from operator");
        //4?????????????????java.sql.PreparedStatement???????????????????java.sql.ResultSet
        ResultSet rs = pstmt.executeQuery();

        //???????????????
        while (rs.next()) {
            //??????��???????��???????????????
			/*
			int id = rs.getInt("id");  //id???????? 
			String name = rs.getString("name"); //name????????
			Operator operator = new Operator(id, name); //??????????Operator??????
			operators[i] = operator;
			i++;
			*/

            operators[i++] = new Operator(rs.getInt("id"), rs.getString("username"), rs.getString("password"), rs.getString("tel"),
                    rs.getString("pic"), rs.getString("reserve"), new RoleDAO().findByPrimaryKey(rs.getInt("role")));
        }
        //????????????
        super.closeConnection(conn);
        //????????
        return operators;
    }

    /**
     * ???????????�b??
     *
     * @return ???????��????��?????????operator???????????????
     * @throws ClassNotFoundException
     * @throws SQLException
     */
    public Operator findByPrimaryKey(int ID) throws ClassNotFoundException, SQLException {
        Operator operator = new Operator();
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????��???????��??1???????????????????????
        PreparedStatement pstmt = conn.prepareStatement("select * from operator where id=?");
        //4?????????????????java.sql.PreparedStatement???????????????????java.sql.ResultSet
        pstmt.setInt(1, ID);
        ResultSet rs = pstmt.executeQuery();

        //?????????????????????????????????????????????????????��???
        if (rs.next()) {
            //??????��???????��???????????????
            int id = rs.getInt("id");  //id????????
            String username = rs.getString("username"); //username????????
            String password = rs.getString("password");
            String tel = rs.getString("tel");
            String pic = rs.getString("pic");
            String reserve = rs.getString("reserve");
            Role role = new RoleDAO().findByPrimaryKey(rs.getInt("role"));
            operator = new Operator(id, username, password, tel, pic, reserve, role); //??????????Operator??????
//			operator = new Operator(rs.getInt("id"), rs.getString("username"),rs.getString("password"),rs.getString("tel"),
//			rs.getString("pic"),rs.getString("reserve"),new RoleDAO().findByPrimaryKey(rs.getInt("role"))); //??��?????

        }
        //????????????
        super.closeConnection(conn);
        //????????
        return operator;
    }

    //??????????��????????
    private int findTotal() throws ClassNotFoundException, SQLException {
        int total = 0;
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????��???????��??1???????????????????????
        PreparedStatement pstmt = conn.prepareStatement("select  count(*) from operator");
        //4?????????????????java.sql.PreparedStatement???????????????????java.sql.ResultSet
        ResultSet rs = pstmt.executeQuery();

        //???????????????
        if (rs.next()) {
            //??????��???????��???????????????
            total = rs.getInt(1);  // ???1???????????????? count(*)????????
        }
        //????????????
        super.closeConnection(conn);
        return total;
    }

}

